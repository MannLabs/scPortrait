
<!DOCTYPE html>


<html lang="en" data-content_root="../../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Segmentation &#8212; scPortrait</title>



  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  <!--
    this give us a css class that will be invisible only if js is disabled
  -->
  <noscript>
    <style>
      .pst-js-only { display: none !important; }

    </style>
  </noscript>

  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=26a4bc78f4c0ddb94549" rel="stylesheet" />
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=26a4bc78f4c0ddb94549" rel="stylesheet" />

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=a746c00c" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/sphinx-book-theme.css?v=a3416100" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-design.min.css?v=95c83b7e" />

  <!-- So that users can add custom icons -->
  <script src="../../_static/scripts/fontawesome.js?digest=26a4bc78f4c0ddb94549"></script>
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/bootstrap.js?digest=26a4bc78f4c0ddb94549" />
<link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=26a4bc78f4c0ddb94549" />

    <script src="../../_static/jquery.js?v=5d32c60e"></script>
    <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
    <script src="../../_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="../../_static/doctools.js?v=9a2dae69"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script src="../../_static/design-tabs.js?v=f930bc37"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'pages/pipeline/segmentation';</script>
    <link rel="icon" href="../../_static/favicon.png"/>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Extraction" href="extraction.html" />
    <link rel="prev" title="Stitching" href="stitching.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  <meta name="docsearch:version" content="" />
  </head>


  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">



  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>

  <div id="pst-scroll-pixel-helper"></div>

  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>


  <dialog id="pst-search-dialog">

<form class="bd-search d-flex align-items-center"
      action="../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         placeholder="Search..."
         aria-label="Search..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form>
  </dialog>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>


    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>


  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">



      <dialog id="pst-primary-sidebar-modal"></dialog>
      <div id="pst-primary-sidebar" class="bd-sidebar-primary bd-sidebar">



  <div class="sidebar-header-items sidebar-primary__section">




  </div>

    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">





<a class="navbar-brand logo" href="../../index.html">










    <img src="../../_static/scPortrait_logo_light.svg" class="logo__image only-light" alt="scPortrait - Home"/>
    <img src="../../_static/scPortrait_logo_dark.svg" class="logo__image only-dark pst-js-only" alt="scPortrait - Home"/>


</a></div>
        <div class="sidebar-primary-item">

<button class="btn search-button-field search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
 <i class="fa-solid fa-magnifying-glass"></i>
 <span class="search-button__default-text">Search</span>
 <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
</button></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Ecosystem</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../quickstart.html">Quickstart</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../quickstart/installation.html">Installation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../quickstart/introduction.html">Introduction</a></li>
<li class="toctree-l2"><a class="reference internal" href="../notebooks/example_scPortrait_project.html">A walk through the scPortrait Ecosystem</a></li>
</ul>
</details></li>
<li class="toctree-l1 current active has-children"><a class="reference internal" href="../pipeline.html">Workflow</a><details open="open"><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="project.html">scPortrait Projects</a></li>
<li class="toctree-l2"><a class="reference internal" href="config.html">Config Files</a></li>
<li class="toctree-l2"><a class="reference internal" href="spatialdata.html">SpatialData</a></li>
<li class="toctree-l2"><a class="reference internal" href="stitching.html">Stitching</a></li>
<li class="toctree-l2 current active"><a class="current reference internal" href="#">Segmentation</a></li>
<li class="toctree-l2"><a class="reference internal" href="extraction.html">Extraction</a></li>
<li class="toctree-l2"><a class="reference internal" href="featurization.html">Featurization</a></li>
<li class="toctree-l2"><a class="reference internal" href="selection.html">Selection</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../tutorials.html">Tutorials</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../notebooks/example_scPortrait_project.html">A walk through the scPortrait Ecosystem</a></li>
<li class="toctree-l2"><a class="reference internal" href="../notebooks/example_notebook_segmentation_workflows.html">Different segmentation workflows</a></li>
</ul>
</details></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Tools</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../tools/parsing/parsing.html">Parsing</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../tools/parsing/example_parsing_notebook.html">Example Parsing Notebook to rename phenix experiments</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../tools/stitching/stitching.html">Stitching</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../tools/stitching/example_stitching_notebook.html">Example Stitching Notebook</a></li>
</ul>
</details></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Module API</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../module.html">Module Documentation</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2 has-children"><a class="reference internal" href="../module/pipeline.html">pipeline</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul class="simple">
</ul>
</details></li>
<li class="toctree-l2"><a class="reference internal" href="../module/processing.html">processing</a></li>
<li class="toctree-l2"><a class="reference internal" href="../module/io.html">io</a></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../module/tools.html">tools</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l3"><a class="reference internal" href="../module/tools/parsing.html">parse</a></li>


<li class="toctree-l3"><a class="reference internal" href="../module/tools/stitching.html">stitch</a></li>


<li class="toctree-l3 has-children"><a class="reference internal" href="../module/tools/ml.html">ml</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul class="simple">
</ul>
</details></li>
</ul>
</details></li>
</ul>
</details></li>
</ul>

    </div>
</nav></div>
    </div>


  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>

  <div id="rtd-footer-container"></div>


      </div>

      <main id="main-content" class="bd-main" role="main">



<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">

              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">

    <div class="header-article-items__start">

        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>

    </div>


    <div class="header-article-items__end">

        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">



      <li><a href="../../_sources/pages/pipeline/segmentation.rst" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>


<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.rst</span>
</a>
</li>




      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>


<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>

  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>


<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" aria-label="Color mode" data-bs-title="Color mode"  data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="theme-switch fa-solid fa-sun                fa-lg" data-mode="light" title="Light"></i>
  <i class="theme-switch fa-solid fa-moon               fa-lg" data-mode="dark"  title="Dark"></i>
  <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"  title="System Settings"></i>
</button>


<button class="btn btn-sm pst-navbar-icon search-button search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
</button>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>

    </div>

</div>
</div>



<div id="jb-print-docs-body" class="onlyprint">
    <h1>Segmentation</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">

            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#segmentation-classes">Segmentation classes</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id2">1. Segmentation</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#shardedsegmentation">2. ShardedSegmentation</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#configuration-parameters">Configuration parameters</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#timecoursesegmentation">3. TimecourseSegmentation</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#multithreadedsegmentation">4. MultithreadedSegmentation</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id3">Configuration parameters</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#segmentation-workflows">Segmentation Workflows</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#wga-segmentation">WGA segmentation</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#nucleus-segmentation-algorithm">Nucleus Segmentation Algorithm</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#cytosol-segmentation-algorithm">Cytosol Segmentation Algorithm</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#dapi-segmentation">DAPI segmentation</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id6">Nucleus Segmentation Algorithm</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#cytosol-cellpose-segmentation">Cytosol Cellpose segmentation</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#dapi-cellpose-segmentation">DAPI Cellpose segmentation</a></li>
</ul>
</li>
</ul>
            </nav>
        </div>
    </div>
</div>



<div id="searchbox"></div>
                <article class="bd-article">

  <section id="segmentation">
<span id="id1"></span><h1>Segmentation<a class="headerlink" href="#segmentation" title="Link to this heading">#</a></h1>
<p>Segmentation is an essential step in the scPortrait workflow. The goal of segmentation is to generate a mask which maps the pixels of the input image to individual cells, which are then assigned a unique <code class="docutils literal notranslate"><span class="pre">cell</span> <span class="pre">id</span></code>. Background pixels are assigned the value <code class="docutils literal notranslate"><span class="pre">0</span></code>. In scPortrait we distinguish two different types of segmentation masks: nuclear and cytosolic. Nuclear masks &lt;…&gt; Cytosolic masks &lt;…&gt;.</p>
<div class="pst-scrollable-table-container"><table class="table">
<tbody>
<tr class="row-odd"><td><p>Input Image</p></td>
<td><p>Nucleus Mask</p></td>
<td><p>Cytosol Mask</p></td>
</tr>
<tr class="row-even"><td><p><a class="reference internal" href="../../_images/input_image.png"><img alt="pic1" src="../../_images/input_image.png" style="width: 100%;" /></a></p></td>
<td><p><a class="reference internal" href="../../_images/nucleus_mask.png"><img alt="pic2" src="../../_images/nucleus_mask.png" style="width: 100%;" /></a></p></td>
<td><p><a class="reference internal" href="../../_images/cytosol_mask.png"><img alt="pic3" src="../../_images/cytosol_mask.png" style="width: 100%;" /></a></p></td>
</tr>
</tbody>
</table>
</div>
<p>To ensure overall flexibility, scPortrait seperates the segmentation code framework (i.e. loading input data, calling a segmentation method or saving results) from the actual segmentation algorithm (i.e. how the segmentation mask is calculated for a given input).</p>
<p>The segmentation code framework is implemented through so called segmentation classes. Each class is optimized for a given input data format and level of parallelization. The segmentation algorithms themselves are implemented by so called segmentation workflows. Each workflow implements a different segmentation algorithm (e.g. thresholding based segmentation or deep learning based segmentation).</p>
<p>Using class inheritance each segmentation workflow inherits from a segmentation class to provide the segmentation code framework, but updates the segmentation generation method with the desired algorithm. This way you can easily exchange one segmentation algorithm for another while retaining the rest of the code framework.</p>
<section id="segmentation-classes">
<h2>Segmentation classes<a class="headerlink" href="#segmentation-classes" title="Link to this heading">#</a></h2>
<p>scPortrait currently implements two different segmentation classes for each of the input data formats: a serialized segmentation class and a parallelized segmentation class. The serialized segmentation class is ideal for segmenting small input images on only one process. The parallelized segmentation classes can also process larger input images over multiple CPU cores.</p>
<a class="reference internal image-reference" href="../../_images/segmentation_classes.png"><img alt="Segmentation classes overview" class="align-center" src="../../_images/segmentation_classes.png" style="width: 100%;" /></a>
<section id="id2">
<h3>1. Segmentation<a class="headerlink" href="#id2" title="Link to this heading">#</a></h3>
<p>The <a class="reference internal" href="../module/pipeline.html#scportrait.pipeline.segmentation.Segmentation" title="scportrait.pipeline.segmentation.Segmentation"><code class="xref py py-func docutils literal notranslate"><span class="pre">Segmentation</span></code></a> class is optimized for processing input images of the format CXY within the context of a base scPortrait <a class="reference internal" href="../module/pipeline.html#scportrait.pipeline.project.Project" title="scportrait.pipeline.project.Project"><code class="xref py py-func docutils literal notranslate"><span class="pre">Project</span></code></a>. It loads the input image into memory and then segments the image using the provided segmentation workflow. The resulting segmentation mask is then saved to disk.</p>
</section>
<section id="shardedsegmentation">
<h3>2. ShardedSegmentation<a class="headerlink" href="#shardedsegmentation" title="Link to this heading">#</a></h3>
<p>The <a class="reference internal" href="../module/pipeline.html#scportrait.pipeline.segmentation.ShardedSegmentation" title="scportrait.pipeline.segmentation.ShardedSegmentation"><code class="xref py py-func docutils literal notranslate"><span class="pre">ShardedSegmentation</span></code></a> class is an extension of the <a class="reference internal" href="../module/pipeline.html#scportrait.pipeline.segmentation.Segmentation" title="scportrait.pipeline.segmentation.Segmentation"><code class="xref py py-func docutils literal notranslate"><span class="pre">Segmentation</span></code></a> class which is optimized for processing large input images in the format CXY in a parallelized fashion. When loading the input image, the <a class="reference internal" href="../module/pipeline.html#scportrait.pipeline.segmentation.ShardedSegmentation" title="scportrait.pipeline.segmentation.ShardedSegmentation"><code class="xref py py-func docutils literal notranslate"><span class="pre">ShardedSegmentation</span></code></a> class splits the provided image into smaller tiles, called shards, which can then be processed individually in a parallelized fashion. After segmentation of the individual shards is completed, the <a class="reference internal" href="../module/pipeline.html#scportrait.pipeline.segmentation.ShardedSegmentation" title="scportrait.pipeline.segmentation.ShardedSegmentation"><code class="xref py py-func docutils literal notranslate"><span class="pre">ShardedSegmentation</span></code></a> class merges the individual tiles back together to generate a final segmentation mask which extends over the complete input image.</p>
<p>Using a shardings approach has two main advantages:</p>
<blockquote>
<div><ol class="arabic simple">
<li><p>the possibility to segment images larger than the available memory the segmentation of images</p></li>
<li><p>the parallelized segmentation of shards over mutiple threads to better utilize the available hardware</p></li>
</ol>
</div></blockquote>
<p>To determine how many shards should be generated, the user specifies the maximum number of pixels that can be allocated to one shard via the configuration file (<code class="docutils literal notranslate"><span class="pre">shard_size</span></code>). scPortrait then dynamically calculates a so-called <cite>sharding plan</cite> which splits the input image into the minimum number of equally sized shards. If desired, the user can also specify a pixel overlap (<code class="docutils literal notranslate"><span class="pre">overlap_px</span></code>) which determines how far the shards should overlap. This can be useful to ensure that cells which are located on the border between two shards are still fully segmented.</p>
<p>The <a class="reference internal" href="../module/pipeline.html#scportrait.pipeline.segmentation.ShardedSegmentation" title="scportrait.pipeline.segmentation.ShardedSegmentation"><code class="xref py py-func docutils literal notranslate"><span class="pre">ShardedSegmentation</span></code></a> class then segments each of the calculated shards individually using the designated number of parallel processes (<code class="docutils literal notranslate"><span class="pre">threads</span></code>). The intermediate segmentation results from each shard are saved to disk  before proceeding with the next shard. This ensures that memory usage during the segmentation process is kept to a minimum as only the required data to calculate the current shard segmentation are retained in memory.</p>
<p>After segmentation of each individual shard is completed, the <a class="reference internal" href="../module/pipeline.html#scportrait.pipeline.segmentation.ShardedSegmentation" title="scportrait.pipeline.segmentation.ShardedSegmentation"><code class="xref py py-func docutils literal notranslate"><span class="pre">ShardedSegmentation</span></code></a> class merges the individual segmentation masks back together to generate a final segmentation mask which extends over the complete input image. During this process the <code class="docutils literal notranslate"><span class="pre">cell</span> <span class="pre">ids</span></code> are adjusted on each shard so that they remain unique throughout the final segmentation mask. After this process is completed the final segmentation mask is saved to disk and all intermediate results are deleted.</p>
<section id="configuration-parameters">
<h4>Configuration parameters<a class="headerlink" href="#configuration-parameters" title="Link to this heading">#</a></h4>
<p>The following parameters for a sharded segmentation need to be specified in the configuration file:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">ShardedSegmentationWorkflow</span><span class="p">:</span>
<span class="w">    </span><span class="nt">shard_size</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1000000000</span><span class="w"> </span><span class="c1"># maximum number of pixels that can be allocated to one shard</span>
<span class="w">    </span><span class="nt">overlap_px</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0</span><span class="w"> </span><span class="c1"># number of pixels by which the shards should overlap</span>
<span class="w">    </span><span class="nt">threads</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">2</span><span class="w"> </span><span class="c1"># number of threads to be used for parallelized segmentation of shards</span>
<span class="w">    </span><span class="l l-Scalar l-Scalar-Plain">... additional workflow specific parameters...</span>
</pre></div>
</div>
</section>
</section>
<section id="timecoursesegmentation">
<h3>3. TimecourseSegmentation<a class="headerlink" href="#timecoursesegmentation" title="Link to this heading">#</a></h3>
<p>The <code class="xref py py-func docutils literal notranslate"><span class="pre">TimecourseSegmentation</span></code> class is optimized for processing input images of the format NCXY within the context of a scPortrait <code class="xref py py-func docutils literal notranslate"><span class="pre">Timecourse</span> <span class="pre">Project</span></code>. It loads the input images into memory and segments them sequentially using the provided segmentation workflow. The resulting segmentation masks are then saved to disk.</p>
</section>
<section id="multithreadedsegmentation">
<h3>4. MultithreadedSegmentation<a class="headerlink" href="#multithreadedsegmentation" title="Link to this heading">#</a></h3>
<p>The <code class="xref py py-func docutils literal notranslate"><span class="pre">MultithreadedSegmentation</span></code> class is an extension of the <code class="xref py py-func docutils literal notranslate"><span class="pre">TimecourseSegmentation</span></code> class and segments input images in the format NCYX in a parallelized fashion. The parallelization is achieved by splitting the input images along the N axis and processing each imagestack individually. The number of parallel processes can be specified by the user via the configuration file (<code class="docutils literal notranslate"><span class="pre">threads</span></code>).</p>
<section id="id3">
<h4>Configuration parameters<a class="headerlink" href="#id3" title="Link to this heading">#</a></h4>
<p>The following parameters for a multithreaded segmentation need to be specified in the configuration file:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">MultithreadedSegmentationWorkflow</span><span class="p">:</span>
<span class="w">    </span><span class="nt">threads</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">2</span><span class="w"> </span><span class="c1"># number of threads to be used for parallelized segmentation of shards</span>
<span class="w">    </span><span class="l l-Scalar l-Scalar-Plain">... additional workflow specific parameters...</span>
</pre></div>
</div>
</section>
</section>
</section>
<section id="segmentation-workflows">
<h2>Segmentation Workflows<a class="headerlink" href="#segmentation-workflows" title="Link to this heading">#</a></h2>
<p>Within scPortrait a segmentation workflow refers to a specific segmentation algorithm that can be called by one of the segmentation classes described above. Currently the following segmentation workflows are available for each of the different segmentation classes. They are explained in more detail below:</p>
<ul class="simple">
<li><p><a class="reference internal" href="#wga-segmentation"><span class="std std-ref">WGA segmentation</span></a></p></li>
<li><p><a class="reference internal" href="#dapi-segmentation"><span class="std std-ref">DAPI segmentation</span></a></p></li>
<li><p><a class="reference internal" href="#cytosol-segmentation-cellpose"><span class="std std-ref">Cytosol Cellpose segmentation</span></a></p></li>
<li><p><a class="reference internal" href="#dapi-segmentation-cellpose"><span class="std std-ref">DAPI Cellpose segmentation</span></a></p></li>
</ul>
<p>If none of these segmentation approaches suit your particular needs you can easily implement your own workflow. In case you need help, please open a git issue.</p>
<section id="wga-segmentation">
<span id="id4"></span><h3>WGA segmentation<a class="headerlink" href="#wga-segmentation" title="Link to this heading">#</a></h3>
<p>This segmentation workflow aims to segment mononucleated cells, i.e. cells that contain exactly one nucleus. Based on a nuclear stain and a cellmembrane stain, it first uses a thresholding approach to identify nuclei which are assumed to be the center of each cell. Then in a second step, the center of the identified nuclei are used as a starting point to generate a potential map using the cytosolic stain. This potential map is then used to segment the cytosol using a watershed approach. At the end of the workflow the user obtains both a nuclear and a cytosolic segmentation mask where each cytosol is matched to exactly one nucleus as kann be identified by the matching <code class="docutils literal notranslate"><span class="pre">cell</span> <span class="pre">id</span></code>.</p>
<p>This segmentation workflow is implemented to only run on the CPU. As such it can easily be scaled up to run on large datasets using parallel processing over multiple cores using either the <a class="reference internal" href="../module/pipeline.html#scportrait.pipeline.segmentation.ShardedSegmentation" title="scportrait.pipeline.segmentation.ShardedSegmentation"><code class="xref py py-func docutils literal notranslate"><span class="pre">ShardedSegmentation</span></code></a> class or the <code class="xref py py-func docutils literal notranslate"><span class="pre">MultithreadedSegmentation</span></code> class respectively. However, it has a lot of parameters that need to be adjusted for different datasets to obtain an optimal segmentation.</p>
<div class="literal-block-wrapper docutils container" id="id9">
<div class="code-block-caption"><span class="caption-text">Example configuration for  WGASegmentation</span><a class="headerlink" href="#id9" title="Link to this code">#</a></div>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">WGASegmentation</span><span class="p">:</span>
<span class="w">    </span><span class="nt">input_channels</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">3</span>
<span class="w">    </span><span class="nt">chunk_size</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">50</span><span class="w"> </span><span class="c1"># chunk size for chunked HDF5 storage. is needed for correct caching and high performance reading. should be left at 50.</span>
<span class="w">    </span><span class="nt">lower_quantile_normalization</span><span class="p">:</span><span class="w">   </span><span class="l l-Scalar l-Scalar-Plain">0.001</span>
<span class="w">    </span><span class="nt">upper_quantile_normalization</span><span class="p">:</span><span class="w">   </span><span class="l l-Scalar l-Scalar-Plain">0.999</span>
<span class="w">    </span><span class="nt">median_filter_size</span><span class="p">:</span><span class="w">   </span><span class="l l-Scalar l-Scalar-Plain">4</span><span class="w"> </span><span class="c1"># Size in pixels</span>
<span class="w">    </span><span class="nt">nucleus_segmentation</span><span class="p">:</span>
<span class="w">        </span><span class="nt">lower_quantile_normalization</span><span class="p">:</span><span class="w">   </span><span class="l l-Scalar l-Scalar-Plain">0.01</span><span class="w"> </span><span class="c1"># quantile normalization of dapi channel before local tresholding. Strong normalization (0.05,0.95) can help with nuclear speckles.</span>
<span class="w">        </span><span class="nt">upper_quantile_normalization</span><span class="p">:</span><span class="w">   </span><span class="l l-Scalar l-Scalar-Plain">0.99</span><span class="w"> </span><span class="c1"># quantile normalization of dapi channel before local tresholding. Strong normalization (0.05,0.95) can help with nuclear speckles.</span>
<span class="w">        </span><span class="nt">median_block</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">41</span><span class="w"> </span><span class="c1"># Size of pixel disk used for median, should be uneven</span>
<span class="w">        </span><span class="nt">median_step</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">4</span>
<span class="w">        </span><span class="nt">threshold</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.2</span><span class="w"> </span><span class="c1"># threshold above which nucleus is detected, if not specified a global threshold is calcualted using otsu</span>
<span class="w">        </span><span class="nt">min_distance</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">8</span><span class="w"> </span><span class="c1"># minimum distance between two nucleis in pixel</span>
<span class="w">        </span><span class="nt">peak_footprint</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">7</span><span class="w"> </span><span class="c1">#</span>
<span class="w">        </span><span class="nt">speckle_kernel</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">9</span><span class="w"> </span><span class="c1"># Erosion followed by Dilation to remove speckels, size in pixels, should be uneven</span>
<span class="w">        </span><span class="nt">dilation</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0</span><span class="w"> </span><span class="c1"># final dilation of pixel mask</span>
<span class="w">        </span><span class="nt">min_size</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">200</span><span class="w"> </span><span class="c1"># minimum nucleus area in pixel</span>
<span class="w">        </span><span class="nt">max_size</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">5000</span><span class="w"> </span><span class="c1"># maximum nucleus area in pixel</span>
<span class="w">        </span><span class="nt">contact_filter</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.5</span><span class="w"> </span><span class="c1"># minimum nucleus contact with background</span>
<span class="w">    </span><span class="nt">wga_segmentation</span><span class="p">:</span>
<span class="w">        </span><span class="nt">threshold</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.05</span><span class="w"> </span><span class="c1"># threshold above which cytosol is detected, if not specified a global threshold is calcualted using otsu</span>
<span class="w">        </span><span class="nt">lower_quantile_normalization</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.01</span>
<span class="w">        </span><span class="nt">upper_quantile_normalization</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.99</span>
<span class="w">        </span><span class="nt">erosion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">2</span><span class="w"> </span><span class="c1"># erosion and dilation are used for speckle removal and shrinking / dilation</span>
<span class="w">        </span><span class="nt">dilation</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">7</span><span class="w"> </span><span class="c1"># for no change in size choose erosion = dilation, for larger cells increase the mask erosion</span>
<span class="w">        </span><span class="nt">min_clip</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0</span>
<span class="w">        </span><span class="nt">max_clip</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.2</span>
<span class="w">        </span><span class="nt">min_size</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">200</span>
<span class="w">        </span><span class="nt">max_size</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">30000</span>
<span class="w">    </span><span class="nt">chunk_size</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">50</span>
</pre></div>
</div>
</div>
<section id="nucleus-segmentation-algorithm">
<h4>Nucleus Segmentation Algorithm<a class="headerlink" href="#nucleus-segmentation-algorithm" title="Link to this heading">#</a></h4>
<a class="reference internal image-reference" href="../../_images/WGA_segmentation_nucleus.png"><img alt="Nuclear segmentation algorithm steps" class="align-left" src="../../_images/WGA_segmentation_nucleus.png" style="width: 100%;" /></a>
</section>
<section id="cytosol-segmentation-algorithm">
<h4>Cytosol Segmentation Algorithm<a class="headerlink" href="#cytosol-segmentation-algorithm" title="Link to this heading">#</a></h4>
<a class="reference internal image-reference" href="../../_images/WGA_segmentation_cytosol.png"><img alt="Cytosol segmentation algorithm steps" class="align-left" src="../../_images/WGA_segmentation_cytosol.png" style="width: 100%;" /></a>
</section>
</section>
<section id="dapi-segmentation">
<span id="id5"></span><h3>DAPI segmentation<a class="headerlink" href="#dapi-segmentation" title="Link to this heading">#</a></h3>
<p>This segmentation workflow aims to only segment nuclei. Based on a nuclear stain, it uses the same thresholding approach used during the WGA segmentation to identify nuclei. To ensure compatability with the downstream extraction workflow which assumes the presence of both a nuclear and a cytosolic segmentation mask the nuclear mask is duplicated and also used as the cytosolic mask. The generated single cell datasets using this segmentation method only focus on signals contained within the nuclear region.</p>
<div class="literal-block-wrapper docutils container" id="id10">
<div class="code-block-caption"><span class="caption-text">Example configuration for  WGASegmentation</span><a class="headerlink" href="#id10" title="Link to this code">#</a></div>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">DAPISegmentation</span><span class="p">:</span>
<span class="w">    </span><span class="nt">input_channels</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">3</span>
<span class="w">    </span><span class="nt">chunk_size</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">50</span><span class="w"> </span><span class="c1"># chunk size for chunked HDF5 storage. is needed for correct caching and high performance reading. should be left at 50.</span>
<span class="w">    </span><span class="nt">lower_quantile_normalization</span><span class="p">:</span><span class="w">   </span><span class="l l-Scalar l-Scalar-Plain">0.001</span>
<span class="w">    </span><span class="nt">upper_quantile_normalization</span><span class="p">:</span><span class="w">   </span><span class="l l-Scalar l-Scalar-Plain">0.999</span>
<span class="w">    </span><span class="nt">median_filter_size</span><span class="p">:</span><span class="w">   </span><span class="l l-Scalar l-Scalar-Plain">4</span><span class="w"> </span><span class="c1"># Size in pixels</span>
<span class="w">    </span><span class="nt">nucleus_segmentation</span><span class="p">:</span>
<span class="w">        </span><span class="nt">lower_quantile_normalization</span><span class="p">:</span><span class="w">   </span><span class="l l-Scalar l-Scalar-Plain">0.01</span><span class="w"> </span><span class="c1"># quantile normalization of dapi channel before local tresholding. Strong normalization (0.05,0.95) can help with nuclear speckles.</span>
<span class="w">        </span><span class="nt">upper_quantile_normalization</span><span class="p">:</span><span class="w">   </span><span class="l l-Scalar l-Scalar-Plain">0.99</span><span class="w"> </span><span class="c1"># quantile normalization of dapi channel before local tresholding. Strong normalization (0.05,0.95) can help with nuclear speckles.</span>
<span class="w">        </span><span class="nt">median_block</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">41</span><span class="w"> </span><span class="c1"># Size of pixel disk used for median, should be uneven</span>
<span class="w">        </span><span class="nt">median_step</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">4</span>
<span class="w">        </span><span class="nt">threshold</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.2</span><span class="w"> </span><span class="c1"># threshold above which nucleus is detected, if not specified a global threshold is calcualted using otsu</span>
<span class="w">        </span><span class="nt">min_distance</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">8</span><span class="w"> </span><span class="c1"># minimum distance between two nucleis in pixel</span>
<span class="w">        </span><span class="nt">peak_footprint</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">7</span><span class="w"> </span><span class="c1">#</span>
<span class="w">        </span><span class="nt">speckle_kernel</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">9</span><span class="w"> </span><span class="c1"># Erosion followed by Dilation to remove speckels, size in pixels, should be uneven</span>
<span class="w">        </span><span class="nt">dilation</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0</span><span class="w"> </span><span class="c1"># final dilation of pixel mask</span>
<span class="w">        </span><span class="nt">min_size</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">200</span><span class="w"> </span><span class="c1"># minimum nucleus area in pixel</span>
<span class="w">        </span><span class="nt">max_size</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">5000</span><span class="w"> </span><span class="c1"># maximum nucleus area in pixel</span>
<span class="w">        </span><span class="nt">contact_filter</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.5</span><span class="w"> </span><span class="c1"># minimum nucleus contact with background</span>
<span class="w">    </span><span class="nt">chunk_size</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">50</span>
</pre></div>
</div>
</div>
<section id="id6">
<h4>Nucleus Segmentation Algorithm<a class="headerlink" href="#id6" title="Link to this heading">#</a></h4>
<a class="reference internal image-reference" href="../../_images/WGA_segmentation_nucleus.png"><img alt="Nuclear segmentation algorithm steps" class="align-center" src="../../_images/WGA_segmentation_nucleus.png" style="width: 100%;" /></a>
</section>
</section>
<section id="cytosol-cellpose-segmentation">
<span id="cytosol-segmentation-cellpose"></span><h3>Cytosol Cellpose segmentation<a class="headerlink" href="#cytosol-cellpose-segmentation" title="Link to this heading">#</a></h3>
<p>This segmentation workflow is built around the cellular segmentation algorithm <a class="reference external" href="https://cellpose.readthedocs.io/en/latest/">cellpose</a> . Cellpose is a deep neural network with a U-net style architecture that was trained on large datasets of microscopy images of cells. It provides very accurate out of the box segmentation models for both nuclei and cytosols but also allows you to fine-tune models using your own data.</p>
<p>The scPortrait implementation of the cellpose segmenation algorithm allows you to perform both a nuclear and cytosolic segmentation and align the <code class="docutils literal notranslate"><span class="pre">cellids</span></code> between the two resulting masks. This means that the nucleus and the cytosol belonging to the same cell have the same <code class="docutils literal notranslate"><span class="pre">cellids</span></code>. Furthermore, it performs some filtering steps to remove the masks from multi-nucleated cells or those with only a nuclear or cytosolic mask. This ensures that only cells which show a normal physiology are retained for further analysis.</p>
<p>While this segmentation workflow is also capable of running on a CPU it is highly recommended to utilize a GPU for better performance.</p>
<p>If you utilize this segmentation workflow please also consider citing the <a class="reference external" href="https://www.nature.com/articles/s41592-022-01663-4#Sec8">cellpose paper</a>.</p>
<div class="literal-block-wrapper docutils container" id="id11">
<div class="code-block-caption"><span class="caption-text">Example configuration for  Sharded Cytosol Cellpose Segmentation</span><a class="headerlink" href="#id11" title="Link to this code">#</a></div>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">ShardedCytosolSegmentationCellpose</span><span class="p">:</span>
<span class="w">    </span><span class="c1">#segmentation class specific</span>
<span class="w">    </span><span class="nt">input_channels</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">2</span>
<span class="w">    </span><span class="nt">output_masks</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">2</span>
<span class="w">    </span><span class="nt">shard_size</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">120000000</span><span class="w"> </span><span class="c1"># maxmimum number of pixel per tile</span>
<span class="w">    </span><span class="nt">overlap_px</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">100</span>
<span class="w">    </span><span class="nt">chunk_size</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">50</span><span class="w"> </span><span class="c1"># chunk size for chunked HDF5 storage. is needed for correct caching and high performance reading. should be left at 50.</span>
<span class="w">    </span><span class="nt">threads</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1</span><span class="w"> </span><span class="c1"># number of shards / tiles segmented at the same size. should be adapted to the maximum amount allowed by memory.</span>
<span class="w">    </span><span class="nt">cache</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;/fs/pool/pool-mann-maedler-shared/temp&quot;</span>
<span class="w">    </span><span class="c1">#segmentation workflow specific</span>
<span class="w">    </span><span class="nt">nGPUs</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">2</span>
<span class="w">    </span><span class="nt">lower_quantile_normalization</span><span class="p">:</span><span class="w">   </span><span class="l l-Scalar l-Scalar-Plain">0.001</span>
<span class="w">    </span><span class="nt">upper_quantile_normalization</span><span class="p">:</span><span class="w">   </span><span class="l l-Scalar l-Scalar-Plain">0.999</span>
<span class="w">    </span><span class="nt">median_filter_size</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">6</span><span class="w"> </span><span class="c1"># Size in pixels</span>
<span class="w">    </span><span class="nt">nucleus_segmentation</span><span class="p">:</span>
<span class="w">        </span><span class="nt">model</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;nuclei&quot;</span>
<span class="w">    </span><span class="nt">cytosol_segmentation</span><span class="p">:</span>
<span class="w">        </span><span class="nt">model</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;cyto2&quot;</span>
<span class="w">    </span><span class="nt">chunk_size</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">50</span>
<span class="w">    </span><span class="nt">filtering_threshold</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.95</span>
</pre></div>
</div>
</div>
</section>
<section id="dapi-cellpose-segmentation">
<span id="dapi-segmentation-cellpose"></span><h3>DAPI Cellpose segmentation<a class="headerlink" href="#dapi-cellpose-segmentation" title="Link to this heading">#</a></h3>
<p>This segmentation workflow is also built around the cellular segmentation algorithm <a class="reference external" href="https://cellpose.readthedocs.io/en/latest/">cellpose</a>  but only performs a nuclear segmentation. To ensure compatability with the downstream extraction workflow which assumes the presence of both a nuclear and a cytosolic segmentation mask the nuclear mask is duplicated and also used as the cytosolic mask. The generated single cell datasets using this segmentation method only focus on signals contained within the nuclear region.</p>
<p>As for the <a class="reference internal" href="#cytosol-segmentation-cellpose"><span class="std std-ref">cytosol segmentation cellpose</span></a> workflow it is highly recommended to utilize a GPU.</p>
<p>If you utilize this segmentation workflow please also consider citing the <a class="reference external" href="https://www.nature.com/articles/s41592-022-01663-4#Sec8">cellpose paper</a>.</p>
<div class="literal-block-wrapper docutils container" id="id12">
<div class="code-block-caption"><span class="caption-text">Example configuration for  DAPI Cellpose segmentation</span><a class="headerlink" href="#id12" title="Link to this code">#</a></div>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">ShardedDAPISegmentationCellpose</span><span class="p">:</span>
<span class="w">    </span><span class="c1">#segmentation class specific</span>
<span class="w">    </span><span class="nt">input_channels</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">2</span>
<span class="w">    </span><span class="nt">output_masks</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">2</span>
<span class="w">    </span><span class="nt">shard_size</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">120000000</span><span class="w"> </span><span class="c1"># maxmimum number of pixel per tile</span>
<span class="w">    </span><span class="nt">overlap_px</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">100</span>
<span class="w">    </span><span class="nt">chunk_size</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">50</span><span class="w"> </span><span class="c1"># chunk size for chunked HDF5 storage. is needed for correct caching and high performance reading. should be left at 50.</span>
<span class="w">    </span><span class="nt">cache</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;/fs/pool/pool-mann-maedler-shared/temp&quot;</span>
<span class="w">    </span><span class="c1"># segmentation workflow specific</span>
<span class="w">    </span><span class="nt">nGPUs</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">2</span>
<span class="w">    </span><span class="nt">lower_quantile_normalization</span><span class="p">:</span><span class="w">   </span><span class="l l-Scalar l-Scalar-Plain">0.001</span>
<span class="w">    </span><span class="nt">upper_quantile_normalization</span><span class="p">:</span><span class="w">   </span><span class="l l-Scalar l-Scalar-Plain">0.999</span>
<span class="w">    </span><span class="nt">median_filter_size</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">6</span><span class="w"> </span><span class="c1"># Size in pixels</span>
<span class="w">    </span><span class="nt">nucleus_segmentation</span><span class="p">:</span>
<span class="w">        </span><span class="nt">model</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;nuclei&quot;</span>
</pre></div>
</div>
</div>
</section>
</section>
</section>


                </article>






                <footer class="prev-next-footer d-print-none">

<div class="prev-next-area">
    <a class="left-prev"
       href="stitching.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Stitching</p>
      </div>
    </a>
    <a class="right-next"
       href="extraction.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Extraction</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>

            </div>



                <dialog id="pst-secondary-sidebar-modal"></dialog>
                <div id="pst-secondary-sidebar" class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#segmentation-classes">Segmentation classes</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id2">1. Segmentation</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#shardedsegmentation">2. ShardedSegmentation</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#configuration-parameters">Configuration parameters</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#timecoursesegmentation">3. TimecourseSegmentation</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#multithreadedsegmentation">4. MultithreadedSegmentation</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id3">Configuration parameters</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#segmentation-workflows">Segmentation Workflows</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#wga-segmentation">WGA segmentation</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#nucleus-segmentation-algorithm">Nucleus Segmentation Algorithm</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#cytosol-segmentation-algorithm">Cytosol Segmentation Algorithm</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#dapi-segmentation">DAPI segmentation</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id6">Nucleus Segmentation Algorithm</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#cytosol-cellpose-segmentation">Cytosol Cellpose segmentation</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#dapi-cellpose-segmentation">DAPI Cellpose segmentation</a></li>
</ul>
</li>
</ul>
  </nav></div>

</div></div>


          </div>
          <footer class="bd-footer-content">

<div class="bd-footer-content__inner container">

  <div class="footer-item">

<p class="component-author">
By Sophia Mädler and Niklas Schmacke
</p>

  </div>

  <div class="footer-item">


  <p class="copyright">

      © Copyright 2024 Sophia Mädler and Niklas Schmacke.
      <br/>

  </p>

  </div>

  <div class="footer-item">

  </div>

  <div class="footer-item">

  </div>

</div>
          </footer>


      </main>
    </div>
  </div>

  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script defer src="../../_static/scripts/bootstrap.js?digest=26a4bc78f4c0ddb94549"></script>
<script defer src="../../_static/scripts/pydata-sphinx-theme.js?digest=26a4bc78f4c0ddb94549"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>
